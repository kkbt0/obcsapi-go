<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®°</title>
    <style>
        .items {
            padding: 0px 10px 0px 10px;
            background: var(--codeBackgroundColor);
            border-radius: 5px;
            margin-bottom: 5px;
            margin-top: 5px;
        }
        .items-img img {
            width: 30%;
        }
        .send-button {
            width: 80px;
            height: 50px;
            border-radius: 5px;
            float: right;
            border-color: transparent;
            background: rgba(255, 255, 255, 0.01)
        }
        /*  æ­¤é¡µä¸éœ€è¦å·¥å…·æ  */
        .footer-c {
            display: none;
        }
        .container {
            width: 100%;
            min-height: 75px;
            border-radius: 5px;
            font-size: 20px;
            line-height: 30px;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.05);
            -webkit-user-modify: read-write-plaintext-only;
        }
        .textarea {
            font-size: 18px;
            font-weight: 400;
            color: var(--textColor);
        }
        .textarea {
            border: none;
            outline: none;
            appearance: none;
            padding: 12px;
            box-sizing: border-box;
            height: 200px;
            border-radius: 3px;
            width: 100%;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05)
        }
    </style>
</head>

<body>
    <div id="box">
        <h5>{{ topDataTile }} localStorage {{ version }}</h5>
        <div v-if="mConfig.canPreview" v-html="previewHtml" style="min-height: 75px;"></div>
        <div id="inputTextId" class="container plaintext-only" contenteditable="true" ref="edit"
            v-on:input="inputTextChange" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></div>
        <div style="height:50px">
            <button type="button" @click="clickSend" :disabled="!inputText" class="send-button">ğŸ“å‘é€</button>
            <button type="button" @click="forwardStep" :disabled="!circularQueue.allowForwad()"
                class="send-button">â¡ï¸</button>
            <button type="button" @click="backStep" :disabled="!circularQueue.allowBack()" class="send-button">â¬…ï¸</button>
            <button type="button" @click="mConfig.configBar=!mConfig.configBar" class="send-button"
                style="float:left;">âš™ï¸</button>
        </div>
        <div v-if="mConfig.configBar">
            <input type="checkbox" v-model="mConfig.showDebug"><a href="#/ZK/202209050658?id=debug">Debug</a>
            <input type="checkbox" v-model="mConfig.canPreview" @click="clickForPreview">é¢„è§ˆæ¨¡å¼
            <textarea id="mdSourceInput" v-model="mdSource" placeholder="ç›¯â†_â†" class="textarea"></textarea>
            <button type="button" @click="confirmPostAllMdSource(mdSource)" class="send-button">ğŸ’¾ä¿å­˜</button>
            <button @click="canShowMainList=!canShowMainList">éšè—</button>
        </div><br>
        <div id="ltop"></div>
        <div v-show="!canShowMainList" v-for="(item,index) in mainList" :key="index">
            <div class="items items-img" v-html="item" ref="mit" @click="clickChangePicWidth(index)"></div>
        </div>
        <div v-if="mConfig.showDebug" id="debug">
            <details open>
                <summary>Debug</summary>
                <a href="#/ZK/202209050658?id=ltop">è·³è½¬åˆ°listéšè—é”šç‚¹</a><br>
                <input type="text" v-model="apiUrl">
                <input type="text" v-model="token">
                <br>{{ debugMessageList }}<br>
                <button type="button" @click="clickShowConfig">showConfig</button>
                <button type="button" @click="clickUpdateConfig">updateConfig</button>
                <button type="button" @click="clickInitConfig">initConfig</button>
                <button type="button" @click="clickGetTodayData">è·å–ä»Šæ—¥æ•°æ®</button>
                <span>æ’¤é”€æ¢å¤Debug-å¾ªç¯é˜Ÿåˆ—-</span>{{ circularQueue }}
            </details>
        </div>
    </div>
</body>
<script src="//cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/axios@0.27.2/dist/axios.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/marked@3/marked.min.js"></script>
<script>
    class CircularQueue {
        constructor(k) {
            //ç”¨æ¥ä¿å­˜æ•°æ®é•¿åº¦ä¸ºkçš„æ•°æ®ç»“æ„
            this.list = Array(k).fill("")
            this.allowforwad = 0// å…è®¸å‰è¿›æ•°
            this.allowback = 0 // å…è®¸åé€€æ•° å¯é€šè¿‡æ£€æµ‹list[0]åˆ¤æ–­æ˜¯å¦å¥—åœˆã€‚å¥—åœˆåæ­¤å€¼å¯é€šè¿‡max-allowforwad è·å– å®é™…ä¸Šä½¿ç”¨æ ˆæ›´å¥½å†™ä¸€ç‚¹ æš‚æ—¶æœªè€ƒè™‘å¥—åœˆ
            this.rear = 0 //å½“å‰å…ƒç´ æŒ‡é’ˆ
            this.max = k //é˜Ÿåˆ—çš„é•¿åº¦
            this.allowAdd = 0 //è±å…å…¥é˜Ÿåˆ—æ¬¡æ•° å› ä¸ºæ’¤é”€é‡åšæ“ä½œè§¦å‘å…¥é˜Ÿåˆ—
        }
        addQueue(addstr) { //æ–°å¢å†…å®¹
            if (this.allowAdd != 0) { return; }
            this.rear = (this.rear + 1) % this.max
            this.list[this.rear] = addstr
            this.allowback += 1
            this.allowforwad = 0
        }
        back() { // æŒ‡é’ˆå¾€å æ’¤é”€æ“ä½œ
            this.rear -= 1
            if (this.rear < 0) { this.rear = this.max - 1 }
            this.allowback -= 1
            this.allowforwad += 1
            return this.list[this.rear]
        }
        forward() { // æŒ‡é’ˆå¾€å‰ æ¢å¤æ“ä½œ
            this.rear += 1
            if (this.rear > this.max) { this.rear = 0 }
            this.allowback += 1
            this.allowforwad -= 1
            return this.list[this.rear]
        }
        allowBack() { return (this.allowback > 0) ? true : false }
        allowForwad() { return (this.allowforwad > 0) ? true : false }
    }
    var allMdArr = new Array()
    var vm = new Vue({
        el: '#box',
        data: {
            version: '2.4',
            mConfig: null,
            apiUrl: "", token: "",
            inputText: "",
            mainList: null,
            debugMessageList: ["ä¸¤ä¸ªè¾“å…¥æ¡†ï¼Œç¬¬ä¸€ä¸ªæ˜¯åç«¯apiã€‚ç¬¬äºŒä¸ªæ˜¯ tokenã€‚apiå¡«å†™ç±»ä¼¼ api.ftls.xyz/ob ï¼Œä¸éœ€è¦åè®®å¤´å’Œå°¾éƒ¨æ–œæ ã€‚å¦å¤–tokenå°†åŠ å…¥åˆ°å’Œåç«¯ api çš„ headers ä¸­ Token å­—æ®µã€‚å¡«å†™å®Œæˆåï¼Œç‚¹å‡» updateConfig æŒ‰é’®å¹¶åˆ·æ–°é¡µé¢"],
            previewHtml: '',
            stepTimer: null,
            circularQueue: null,
            mdSource: "",
            canShowMainList: false,
        },
        created() {
            if (!localStorage.hasOwnProperty("mConfig")) {
                console.log("æ²¡æœ‰é…ç½®ï¼Œåˆå§‹åŒ–")
                this.clickInitConfig()
            }
            else {
                this.mConfig = JSON.parse(localStorage.getItem("mConfig"))
            }
            this.topDataTile = (new Date()).toDateString()
            this.inputText = localStorage.getItem('inputTextCache')
            this.moveFocurToEnd("inputTextId")
            this.circularQueue = new CircularQueue(200);
            if (localStorage.hasOwnProperty('mainListCache')) {
                this.mainList = JSON.parse(localStorage.getItem('mainListCache'))
         //       allMdArr = respCache.data
      //          this.mainAllListUpdate()
            }
            this.getData('/recent').then(function (response) {
                allMdArr = response.data; // é•¿åº¦ä¸º3çš„æ•°ç»„
                vm.mainAllListUpdate()
            })
        },
        mounted() {
            this.$refs.edit.innerHTML = this.inputText
        },
        beforeDestroy() {
            clearTimeout(this.stepTimer);
        },
        watch: {
            inputText(val, oldVal) {
                clearTimeout(this.stepTimer);
                this.stepTimer = setTimeout(function () {
                    //console.log(val) 
                    if (vm.circularQueue.allowAdd != 0) {
                        vm.circularQueue.allowAdd -= 1
                    }
                    else {
                        vm.storageStep(val)
                        localStorage.setItem('inputTextCache', val)
                    }
                }, 300);
                if (vm.mConfig.canPreview) { vm.previewHtml = marked(val || '', { breaks: true }); }
            },
            mConfig: {
                handler(val, oldVal) {
                    localStorage.setItem('mConfig', JSON.stringify(val))
                },
                deep: true
            }
        },
        methods: {
            addDebugList(text) {
                //   console.log(text)
                this.debugMessageList.push(text)
            },
            mainAllListUpdate() {
                var val = allMdArr
                this.addDebugList("è§¦å‘ä¸‰å¤©jsonæ›´æ–°")
                this.mdSource = val[val.length - 1].data
                var allHtmlArr = new Array()
                val.forEach(item => {
                    // console.log(item.data)
                    allHtmlArr.push(this.dealDayRaw(item.data, item.date))
                })
                var allItem = []
                for (var i = 0; i < allHtmlArr.length; i++) {
                    for (var j = 0; j < allHtmlArr[i].length; j++)
                        allItem.push(allHtmlArr[i][j])
                }
                this.mainList = allItem.reverse()
localStorage.setItem('mainListCache', JSON.stringify(this.mainList))
            },
            async getData(partUrlPath) {
                let rData;
                url = "//" + this.mConfig.apiUrl + partUrlPath
                let req = axios.create({
                    headers: {
                        Token: this.mConfig.token,
                        'Content-Type': 'application/json'
                    }
                })
                await req.get(url).then(function (response) {
                    vm.addDebugList("Successfully Get")
                    rData = response
                    localStorage.setItem('getDataCache', JSON.stringify(response)) //ç¼“å­˜åˆ°æœ¬åœ°
                }).catch(function (error) {
                    vm.addDebugList("Get Error:")
                    vm.addDebugList(error)
                })
                return rData // raw response
            },
            async postData(text, partUrlPath) {
                let rData;
                url = "//" + this.mConfig.apiUrl + partUrlPath
                let req = axios.create({
                    headers: {
                        Token: this.mConfig.token,
                        'Content-Type': 'application/json'
                    }
                })
                await req.post(url, JSON.stringify({ "content": text })).then(function (response) {
                    vm.addDebugList("Successfully Post")
                    rData = response
                }).catch(function (error) {
                    vm.addDebugList(error)
                })
                return rData
            },
            dealDayRaw(oneDayRaw, date) {
                var data_pre = oneDayRaw // ä¸€å¤©mdæ•°æ® md å†…å®¹çš„ str 
                // console.log(data_pre) 
                data_pre = data_pre.replace(/\!\[(http.*?)\]\((.*?)\)/g, "![$2]($1)")
                data_pre = data_pre.split("\n-")
                // datamd = marked( data_pre || '', { sanitize: true });
                data_pre = data_pre.map(item => {
                    item = item.replace(/(\s\[.\]\s)*([0-2][0-9]\:[0-5][0-9])\s(.*)/g, "$1 <small>" + date + " $2</small><br>$3").replace(/(\s*\[.\])/g, "-$1")
                    item = marked(item || '', { breaks: true });
                    item = item.replace(/<p>(.*)<\/p>/g, "$1")
                    return item
                })
                return data_pre
            },
            clickSend() {
                vm.addDebugList("send è§¦å‘")
                var tem = this
                this.postData(this.inputText, '/today').then(function (res) {
                    vm.addDebugList("send è§¦å‘postå®Œæˆ")
                    vm.setPostText('')
                    vm.moveFocurToEnd("inputTextId")
                    vm.circularQueue.allowback = 0 // å…è®¸åé€€æ’¤é”€æ•° 0å‘é€åå¯ä»¥æ’¤é”€å›åˆ°æœ€å -1å‘é€åç¦ç”¨æ’¤é”€
                    vm.getData('/today').then(function (response) {
                        vm.addDebugList("send è§¦å‘getå®Œæˆ")
                        allMdArr[allMdArr.length - 1] = response.data[0]
                        vm.mainAllListUpdate()
                    })
                })
            },
            clickGetTodayData() {
                var tem = this
                vm.getData('/today').then(function (response) {
                    allMdArr[allMdArr.length - 1] = response.data[0]
                    vm.mainAllListUpdate()
                })
            },
            confirmPostAllMdSource(mdSource) {
                if (confirm('æ›´æ–°æºç ?â—ï¸')) {
                    vm.postData(mdSource, '/today/all').then(function (res) {
                        vm.getData('/today').then(function (response) {
                            allMdArr[allMdArr.length - 1] = response.data[0]
                            vm.mainAllListUpdate()
                        })
                    })
                }
            },
            clickShowConfig() {
                vm.addDebugList(this.mConfig)
            },
            clickUpdateConfig() {
                this.mConfig.apiUrl = this.apiUrl
                this.mConfig.token = this.token
            },
            clickInitConfig() {
                tem = {
                    apiUrl: "api.ftls.xyz/ob", token: "yourtoken",
                    preview: false, configBar: false, showDebug: false, canPreview: false
                }
                localStorage.setItem('mConfig', JSON.stringify(tem))
            },
            clickForPreview() {
                this.previewHtml = marked(this.inputText || '', { breaks: true });
                vm.mConfig.canPreview = !vm.mConfig.canPreview
            },
            storageStep(addstr) {
                this.circularQueue.addQueue(addstr)
            },
            backStep() {
                this.circularQueue.allowAdd += 1
                this.setPostText(this.circularQueue.back())
                this.moveFocurToEnd("inputTextId")
            },
            forwardStep() {
                this.circularQueue.allowAdd += 1
                this.setPostText(this.circularQueue.forward())
                this.moveFocurToEnd("inputTextId")
            },
            setPostText(instr) {
                this.inputText = instr
                this.$refs.edit.innerHTML = instr
            },
            inputTextChange() {
                this.inputText = this.$refs.edit.innerHTML
            },
            clickChangePicWidth(obj) {
                this.$nextTick(() => {
                    this.$refs.mit[obj].classList.toggle('items-img')
                });
            },
            moveFocurToEnd(id) {
                this.$nextTick(() => {
                    let notesDom = document.getElementById(id);
                    if (window.getSelection) {
                        let range = window.getSelection(); // åˆ›å»ºrange
                        range.selectAllChildren(notesDom); // range é€‰æ‹©notesDomä¸‹æ‰€æœ‰å­å†…å®¹
                        range.collapseToEnd(); // å…‰æ ‡ç§»è‡³æœ€å
                    } else if (document.selection) {
                        let range = document.selection.createRange(); // åˆ›å»ºé€‰æ‹©å¯¹è±¡
                        range.moveToElementText(notesDom); // rangeå®šä½åˆ°notesDom
                        range.collapse(false); // å…‰æ ‡ç§»è‡³æœ€å
                        range.select();
                    }
                });
            }
        }
    })
</script>

</html>